#!/bin/sh

self=$(basename $0)

if test -z "$1" -o "$1" = "-h" -o "$1" = "--help"; then
    cat <<EOF
Usage: $self [-o|-s] <filename> <line>
    -o | --open     Open GitLab in browser (default)
    -s | --show     Just show the link
    -y | --yank     Yank with OSC52
    -h | --help     Show help
EOF
    exit 1
fi

# Действие по умолчанию.
action="open"

# Проверяем опции.
if test "$1" = "-o" -o "$1" = "--open"; then
    action="open"
    shift
elif test "$1" = "-s" -o "$1" = "--show"; then
    action="show"
    shift
elif test "$1" = "-y" -o "$1" = "--yank"; then
    action="yank"
    shift
fi

if test ! -f "$1"; then
    echo "$self: file \"$1\" does not exist."
fi

# Определяем полный путь к файлу
file=$(readlink -f "$1")
line="$2"

# Определяем имя файла и каталог.
filename=$(basename "$file")

# Определяем путь к корню репозитория. Для большинства команд git этого не нужно, но в случае, если
# права на файлы в репозитории окажутся какими-то нестандартными, без прямого указания пути к
# каталогу .git возникнет ошибка. Заодно определяем относительный путь к файлу в репозитории.
repopath=$(dirname "$file")
gitpath=""
while true; do
    if test -z "$repopath" -o "$repopath" = "/"; then
        printf "Не удалось найти репозиторий, содержащий файл: %s\n" "$file" 1>&2
        exit 1
    fi

    test -d "$repopath/.git" && break

    gitpath=$(basename "$repopath")"/$gitpath"
    repopath=$(realpath "$repopath/..")
done

git="git -C "$repopath" --git-dir .git"

# Проверяем возможность чтения репозитория.
$git rev-parse 2> /dev/null || { printf "Не удалось прочитать данные репозитория \"%s\"\n" "$repopath" 1>&2; exit 1; }

branch=$($git rev-parse --abbrev-ref HEAD 2> /dev/null)
remote=$($git config branch."$branch".remote || echo "origin")
giturl=$($git remote get-url "$remote")

url="${giturl%.git}"

# Преобразуем git-ссылку в обычную.
if test "${url#git@}" != "${url}"; then
    url=$(echo ${url} | cut -c5- | tr ":" "/")
    url="https://${url}"
fi

# Удаляем учётные данные из URL.
url=$(echo ${url} | sed -r 's/(http[s]?:\/\/)([^@]*@)(.*)/\1\3/')

# Кодируем все части пути urlencode (по отдельности).
gitfile=$(echo "$gitpath$filename" | tr "/" "\n" | jq -Rr @uri | tr "\n" "/" | sed "s|/$||")

commit_hash=$($git log -n1 --format=format:"%H" "${file}" 2>/dev/null)

url="${url}/blob/${commit_hash:-$branch}/$gitfile"

if test -n "${line}"; then
    url="${url}#L${line}"
fi

case "$action" in
    open)
        xdg-open "$url"
        ;;
    show)
        echo "$url"
        ;;
    yank)
        printf "\033]52;c;%s\007" $(echo "$url" | base64 | tr -d "\n")
        ;;
esac
